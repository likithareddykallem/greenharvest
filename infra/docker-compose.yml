version: '3.9'

services:
  mongo:
    image: mongo:7
    restart: always
    ports:
      - '27017:27017'
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7
    restart: always
    ports:
      - '6379:6379'

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      - PORT=4000
      - MONGO_URI=mongodb://mongo:27017/greenharvest
      - REDIS_URL=redis://redis:6379/0
      - CORS_ORIGIN=http://localhost:5173
      - JWT_ACCESS_SECRET=super-secret-access
      - JWT_REFRESH_SECRET=super-secret-refresh
    volumes:
      - ../backend/uploads:/app/uploads
    ports:
      - '4000:4000'
    depends_on:
      - mongo
      - redis

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      - VITE_API_URL=http://localhost:4000
      - VITE_SOCKET_URL=http://localhost:4000
    ports:
      - '5173:4173'
    depends_on:
      - backend

  celery_worker:
    build:
      context: ../celery_worker
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis

  prometheus:
    image: prom/prometheus:v2.54.1
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - '9090:9090'
    depends_on:
      - backend

  grafana:
    image: grafana/grafana:11.1.4
    volumes:
      - ../monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ../monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - '3000:3000'
    depends_on:
      - prometheus

  logstash:
    image: logstash:8.15.1
    volumes:
      - ../monitoring/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    ports:
      - '5044:5044'

volumes:
  mongo_data:

